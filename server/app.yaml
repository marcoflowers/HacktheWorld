---
- hosts: all
  user: ubuntu
  become: true
  become_method: sudo

  tasks:
  - name: Install Packages
    apt: name={{ item }} update_cache=yes state=latest
    with_items:
      - build-essential
      - npm
      - nodejs-legacy
      - git
      - mcrypt
      - nginx
      - curl

  - name: Install pm2
    npm: name=pm2 global=yes production=yes

  - name: Create the SSH public key file
    copy: content=~/.ssh/id_rsa.pub dest=/root/.ssh/id_rsa.pub mode=0644
  - name: Copy Private Key
    copy: src=~/.ssh/id_rsa dest=/root/.ssh/id_rsa mode=0600

  - name: Git Clone Repo
    git: repo=git@github.com:marcoflowers/HackTheWorld.git dest=/home/ubuntu/app update=yes force=yes accept_hostkey=yes key_file=/root/.ssh/id_rsa
    register: git_finished

  - name: Running NPM install
    npm: path=/home/ubuntu/app/server
    register: npm_finished
    when: git_finished.changed

  - name: Stop APP
    sudo_user: ubuntu
    command: pm2 stop process.js chdir=/home/ubuntu/app/server
    ignore_errors: yes

  - name: Start APP
    sudo_user: ubuntu
    command: pm2 start process.js --name app chdir=/home/ubuntu/app/server
    ignore_errors: yes
    when: npm_finished.changed
